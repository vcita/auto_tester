# Phase 2: script.md Rules

## Purpose

The `script.md` file is a **detailed action script** that bridges human intent (steps.md) and executable code (test.py). It contains precise, actionable instructions discovered through browser exploration.

This applies to:
- Tests
- Functions
- Setup/Teardown

## Writing Guidelines

### Content Focus
- Specific actions with exact targets
- Multiple element identification strategies
- Wait conditions after actions
- Verification checkpoints

### Structure for Each Step

Each action should include:
- **Action**: What to do (Click, Type, Wait, Scroll, Call, etc.)
- **Target**: What element to interact with
- **Element hints**: Multiple ways to find the element
- **Value** (if applicable): Data to enter
- **Wait for**: What to expect after the action

### Element Hints

Provide multiple selectors in order of preference:
1. Semantic/accessible selectors (role, label, text)
2. Data attributes (`data-testid`, `data-action`)
3. CSS class selectors
4. Structural selectors (nth-child, etc.)

This redundancy helps self-healing find elements when one selector breaks.

## Example Step

```markdown
### Step 3: Fill Client Email
- **Action**: Type
- **Target**: Email input field
- **Element hints**:
  - `get_by_label("Email")`
  - `input[type="email"]`
  - `input[name="email"]`
  - `.client-form input.email-field`
- **Value**: "test-{timestamp}@example.com"
- **Wait for**: Input contains the typed value
```

## Function Calls in Script

When a step calls a function, the script includes:

```markdown
### Step 2: Create test client
- **Action**: Call function
- **Function**: create_client
- **Parameters**:
  - name: "Test Customer"
  - email: "test-{timestamp}@example.com"
- **Expected return**: created_client_id saved to context
```

## Context Operations

### Saving to Context
```markdown
### Step 5: Save meeting ID
- **Action**: Extract and save
- **Target**: Meeting ID element
- **Element hints**:
  - `.meeting-id`
  - `[data-testid="meeting-id"]`
- **Save to context**: created_meeting_id
- **Pattern**: Extract text matching `MTG-[0-9]+`
```

### Reading from Context
```markdown
### Step 1: Open the meeting
- **Action**: Navigate
- **URL**: "{base_url}/meetings/{context.created_meeting_id}"
```

## Placeholders

Use these placeholders for dynamic values:
- `{timestamp}` - Unix timestamp for unique values
- `{base_url}` - From config.yaml
- `{random_string}` - Random alphanumeric string
- `{context.key}` - Value from shared context
- `{param_name}` - Function parameter value

## Function Script Example

**`tests/_functions/create_client/script.md`:**
```markdown
# Create Client - Detailed Script

## Parameters
- name (required)
- email (required)
- phone (optional)

## Initial State
- URL: Any page (will navigate to CRM)
- User must be logged in

## Actions

### Step 1: Navigate to CRM
- **Action**: Click
- **Target**: CRM menu item
- **Element hints**:
  - `get_by_role("link", name="CRM")`
  - `[data-nav="crm"]`
  - `.nav-item:has-text("CRM")`
- **Wait for**: CRM page loads

### Step 2: Click Add Client
- **Action**: Click
- **Target**: Add client button
- **Element hints**:
  - `get_by_role("button", name="Add Client")`
  - `.btn-add-client`
- **Wait for**: Client form appears

### Step 3: Fill Name
- **Action**: Type
- **Target**: Name field
- **Element hints**:
  - `get_by_label("Name")`
  - `input[name="client_name"]`
- **Value**: "{name}"

### Step 4: Fill Email
- **Action**: Type
- **Target**: Email field
- **Element hints**:
  - `get_by_label("Email")`
  - `input[type="email"]`
- **Value**: "{email}"

### Step 5: Fill Phone (if provided)
- **Action**: Type (conditional)
- **Condition**: phone parameter is provided
- **Target**: Phone field
- **Element hints**:
  - `get_by_label("Phone")`
  - `input[type="tel"]`
- **Value**: "{phone}"

### Step 6: Save Client
- **Action**: Click
- **Target**: Save button
- **Element hints**:
  - `get_by_role("button", name="Save")`
  - `.btn-save`
- **Wait for**: Success message or client detail page

### Step 7: Extract Client ID
- **Action**: Extract and save
- **Target**: Client ID element
- **Element hints**:
  - `.client-id`
  - `[data-client-id]`
- **Save to context**: created_client_id

## Success Verification
- Success message is visible
- Client ID is captured
```

## When to Update script.md

- UI elements change (new selectors discovered)
- New intermediate steps are needed
- Wait conditions need adjustment
- After successful re-exploration

## Generation Process

`script.md` is generated by:
1. Reading the goal from `steps.md`
2. AI explores the browser to achieve each step
3. Recording successful element selectors and actions
4. Documenting wait conditions that worked
5. For function calls, referencing the function's script.md

## Cascade Effect

When `script.md` is updated:
1. Regenerate `test.py` from the updated script
2. Log changes in `changelog.md`
3. If the flow changed significantly, consider updating `steps.md` too
