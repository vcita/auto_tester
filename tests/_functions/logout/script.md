# Function: logout - Detailed Script

> **Status**: Verified with Playwright MCP
> **Last Updated**: 2026-01-21
> **Generated By**: Cursor AI exploration with Playwright MCP

## Parameters
None required.

## Initial State
- User must be logged in
- URL: Any vcita app page (e.g., https://app.vcita.com/app/dashboard)

## Actions

### Step 1: Click User Avatar Button
- **Action**: Click
- **Target**: User avatar button in top-right corner
- **Element hints**:
  - `page.get_by_role("button", name=re.compile(r"^[A-Z]{2}$"))`
  - Button shows user initials (e.g., "AU" for "Autotest")
  - Located in top-right header area
- **Wait for**: Dropdown menu to appear

### Step 2: Wait for Dropdown Menu
- **Action**: Wait
- **Target**: Menu element
- **Element hints**:
  - `page.wait_for_selector("[role='menu']")`
- **Timeout**: 5 seconds

### Step 3: Click Logout Menu Item
- **Action**: Click
- **Target**: "Logout" item in the dropdown menu
- **Element hints**:
  - `page.locator('.logout-item')` (discovered via Playwright MCP)
  - `page.get_by_text("Logout", exact=True)`
  - Last item in the menu, after a separator
- **Wait for**: Page redirect to login

### Step 4: Wait for Login Page
- **Action**: Wait for URL
- **Pattern**: `**/login**`
- **Timeout**: 15 seconds
- **Note**: Cloudflare security check may appear

### Step 5: Handle Cloudflare (if present)
- **Action**: Wait
- **Condition**: Page title changes from "Just a moment..." to actual title
- **Timeout**: 30 seconds

### Step 6: Verify Logout Success
- **Action**: Verify
- **Target**: Login form is visible
- **Element hints**:
  - Login form is inside `#vue_iframe`
  - Look for "Log In to Your Account" text

## Success Verification
- URL contains `/login`
- Login form is visible (either directly or in iframe)
- `logged_in_user` is removed from context

## Context Operations
After successful logout:
```python
if "logged_in_user" in context:
    del context["logged_in_user"]
```

## Dropdown Menu Structure

The user avatar dropdown menu contains:
```
┌─────────────────────────────┐
│ [AU]                        │
│ Autotest                    │
│ itzik+autotest@vcita.com    │
├─────────────────────────────┤
│ My Account                  │
│ Profile                     │
│ Settings                    │
│ Staff                       │
│ Getting started             │
├─────────────────────────────┤
│ Logout                      │
└─────────────────────────────┘
```

## Troubleshooting

### Cloudflare Security Check
- Appears after logout redirect
- Shows "Just a moment..." page title
- Usually resolves automatically in 3-5 seconds
- May require manual CAPTCHA solving in some cases

### Avatar Button Not Found
- Avatar shows 2 uppercase letters (user initials)
- If user has a profile picture, the test needs to be updated with a different selector
- Investigate and fix - do not add fallbacks

### Menu Not Appearing
- Click may not have registered
- Try waiting and clicking again
- Verify page is fully loaded before clicking
